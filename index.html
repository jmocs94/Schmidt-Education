<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sing and Record</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .neon-box {
      border: 4px solid #00ffff;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 10px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .neon-box h1 {
      font-size: 2.5em;
      margin: 0;
    }

    .neon-anim {
      position: absolute;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    canvas#neonCanvas {
      position: absolute;
      top: 0;
      left: 0;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
    }

    .control-icon {
      font-size: 1.5em;
      cursor: pointer;
    }

    .color-picker {
      display: none;
    }

    select, input[type="text"] {
      padding: 10px;
      margin: 10px;
      width: 300px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
    }

    audio, button {
      margin: 10px;
    }

    button {
      padding: 10px 20px;
      font-size: 1em;
      border-radius: 8px;
      border: none;
      background-color: #444;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>

<script>
  const API_KEY = 'AIzaSyBsr1jRZElMibwMiRMek8Z3d204-7uF254';
  const CLIENT_ID = '898010171923-45uc2mbusq1r3p845tl0au0h95lc9r7s.apps.googleusercontent.com';
  const SCOPES = 'https://www.googleapis.com/auth/classroom.coursework.me https://www.googleapis.com/auth/drive.file';
</script>

<div class="neon-box" id="neonBox">
  <h1>Sing and Record</h1>
  <canvas id="neonCanvas" width="400" height="150"></canvas>
  <div class="controls">
    <div class="control-icon" onclick="toggleAnimation()">üí°</div>
    <div class="control-icon" onclick="cycleSpeed()">‚è©</div>
    <div class="control-icon" onclick="document.getElementById('colorPicker').click()">üé®</div>
    <input type="color" id="colorPicker" class="color-picker" onchange="changeColor(this.value)">
  </div>
</div>

<select id="trackSelect" onchange="handleTrackChange(this.value)">
  <option value="">-- Choose a track --</option>
  <option value="custom">Custom URL</option>
  <option value="https://drive.google.com/file/d/1xQA2KQEWAwmiTSClV1q5rwz_Ec2_xdF7/view">Seize the Day</option>
  <option value="https://drive.google.com/file/d/1NaVCLIkSP9nsuGdhVdjHbSl_IIouNreA/view">Go the Distance</option>
  <option value="https://drive.google.com/file/d/1w2JUTr7RWYoDpE8j3qRQfzyFFIYmrTob/view">Life is a Highway</option>
  <option value="https://drive.google.com/file/d/1Q1ZVQnSXfQAktbcOWcTGefp0RwRpJLVD/view">I Lived</option>
</select>

<div id="customUrlInput" style="display: none;">
  <input type="text" id="customUrl" placeholder="Paste Google Drive share link" oninput="validateCustomUrl(this.value)">
  <div id="errorMsg"></div>
</div>

<audio id="backingTrack" controls></audio>

<div>
  <input type="text" id="filenameInput" placeholder="Enter filename...">
  <button onclick="startRecording()">Record</button>
  <button onclick="stopRecording()">Stop</button>
  <audio id="recordedAudio" controls></audio>
  <button id="downloadBtn" onclick="downloadRecording()">Download</button>
  <button onclick="submitToClassroom(document.getElementById('downloadBtn').dataset.blob, getFilename())">Submit to Classroom</button>
  <button onclick="uploadToDrive(document.getElementById('downloadBtn').dataset.blob, getFilename())">Upload to Drive</button>
</div>

<script>
  const audio = document.getElementById('backingTrack');
  const customInput = document.getElementById('customUrlInput');
  const error = document.getElementById('errorMsg');
  let mediaRecorder, audioChunks = [];

  function handleTrackChange(value) {
    error.textContent = '';
    if (value === 'custom') {
      customInput.style.display = 'block';
      audio.src = '';
    } else {
      customInput.style.display = 'none';
      const match = value.match(/\/d\/([^/]+)/);
      if (match) {
        const fileId = match[1];
        fetchAndPlay(fileId);
      } else {
        audio.src = '';
        console.error('Invalid Google Drive link');
      }
    }
  }

  function validateCustomUrl(link) {
    const match = link.match(/https:\/\/drive\.google\.com\/file\/d\/(.+?)\/view/);
    if (!match) {
      error.textContent = 'Only Google Drive links are supported at this time';
      audio.src = '';
      return;
    }
    const fileId = match[1];
    error.textContent = '';
    fetchAndPlay(fileId);
  }

  function fetchAndPlay(fileId) {
    fetch(`https://docs.google.com/uc?export=download&id=${fileId}`)
      .then(res => res.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        audio.src = url;
        audio.load();
      })
      .catch(err => {
        console.error('Error loading audio:', err);
        error.textContent = 'Failed to load audio from Google Drive.';
      });
  }

  function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      audio.play();
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        const recorded = document.getElementById('recordedAudio');
        recorded.src = url;
        document.getElementById('downloadBtn').dataset.blob = blob;
      };
      mediaRecorder.start();
    });
  }

  function stopRecording() {
    if (mediaRecorder) {
      mediaRecorder.stop();
    }
  }

  function getFilename() {
    const input = document.getElementById('filenameInput').value;
    const fallback = 'recording-' + new Date().toISOString().split('T')[0] + '.webm';
    return input ? input : fallback;
  }

  function downloadRecording() {
    const blob = document.getElementById('downloadBtn').dataset.blob;
    if (!blob) return;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = getFilename();
    a.click();
  }
</script>
</body>
</html>
