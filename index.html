<!-- Insert your Google API credentials -->
<script>
  const API_KEY = 'AIzaSyBsr1jRZElMibwMiRMek8Z3d204-7uF254';
  const CLIENT_ID = '898010171923-45uc2mbusq1r3p845tl0au0h95lc9r7s.apps.googleusercontent.com';
  const SCOPES = 'https://www.googleapis.com/auth/classroom.coursework.me https://www.googleapis.com/auth/drive.file';
</script>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sing and Record</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .neon-box {
      border: 4px solid #00ffff;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 10px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .neon-box h1 {
      font-size: 2.5em;
      margin: 0;
    }

    .neon-anim {
      position: absolute;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    canvas#neonCanvas {
      position: absolute;
      top: 0;
      left: 0;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
    }

    .control-icon {
      font-size: 1.5em;
      cursor: pointer;
    }

    .color-picker {
      display: none;
    }

    select, input[type="text"] {
      padding: 10px;
      margin: 10px;
      width: 300px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
    }

    audio, button {
      margin: 10px;
    }

    button {
      padding: 10px 20px;
      font-size: 1em;
      border-radius: 8px;
      border: none;
      background-color: #444;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="neon-box" id="neonBox">
  <h1>Sing and Record</h1>
  <canvas id="neonCanvas" width="400" height="150"></canvas>
  <div class="controls">
    <div class="control-icon" onclick="toggleAnimation()">üí°</div>
    <div class="control-icon" onclick="cycleSpeed()">‚è©</div>
    <div class="control-icon" onclick="document.getElementById('colorPicker').click()">üé®</div>
    <input type="color" id="colorPicker" class="color-picker" onchange="changeColor(this.value)">
  </div>
</div>

<select id="trackSelect" onchange="handleTrackChange(this.value)">
  <option value="">-- Choose a track --</option>
  <option value="custom">Custom URL</option>
  <option value="https://drive.google.com/file/d/1xQA2KQEWAwmiTSClV1q5rwz_Ec2_xdF7/view">Seize the Day</option>
  <option value="https://drive.google.com/file/d/1NaVCLIkSP9nsuGdhVdjHbSl_IIouNreA/view">Go the Distance</option>
  <option value="https://drive.google.com/file/d/1w2JUTr7RWYoDpE8j3qRQfzyFFIYmrTob/view">Life is a Highway</option>
  <option value="https://drive.google.com/file/d/1Q1ZVQnSXfQAktbcOWcTGefp0RwRpJLVD/view">I Lived</option>
</select>

<div id="customUrlInput" style="display: none;">
  <input type="text" id="customUrl" placeholder="Paste Google Drive share link" oninput="validateCustomUrl(this.value)">
  <div id="errorMsg"></div>
</div>

<audio id="backingTrack" controls></audio>

<div>
  <button onclick="startRecording()">Record</button>
  <button onclick="stopRecording()">Stop</button>
  <audio id="recordedAudio" controls></audio>
  <button id="downloadBtn" onclick="downloadRecording()">Download</button>
  <button onclick="submitToClassroom(document.getElementById('downloadBtn').dataset.blob, 'recording-' + new Date().toISOString().split('T')[0] + '.webm')">Submit to Classroom</button>
  <button onclick="uploadToDrive(document.getElementById('downloadBtn').dataset.blob, 'recording-' + new Date().toISOString().split('T')[0] + '.webm')">Upload to Drive</button>
</div>

<script>
  const audio = document.getElementById('backingTrack');
  const customInput = document.getElementById('customUrlInput');
  const error = document.getElementById('errorMsg');

  function handleTrackChange(value) {
    error.textContent = '';
    if (value === 'custom') {
      customInput.style.display = 'block';
      audio.src = '';
    } else {
      customInput.style.display = 'none';
      const match = value.match(/\/d\/([^/]+)(?:\/|$)/);
      if (match) {
        const fileId = match[1];
        audio.src = `https://drive.google.com/uc?export=download&id=${fileId}`;
      } else {
        audio.src = '';
        console.error('Invalid Google Drive link');
      }
    }
  }

  function validateCustomUrl(link) {
    const match = link.match(/https:\/\/drive\.google\.com\/file\/d\/(.+?)\/view/);
    if (!match) {
      error.textContent = 'Only Google Drive links are supported at this time';
      audio.src = '';
      return;
    }
    const fileId = match[1];
    error.textContent = '';
    audio.src = `https://drive.google.com/uc?export=download&id=${fileId}`;
  }

  let mediaRecorder, recordedChunks = [];
  async function startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    recordedChunks = [];
    mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: 'audio/webm' });
      document.getElementById('recordedAudio').src = URL.createObjectURL(blob);
      document.getElementById('downloadBtn').dataset.blob = blob;
    };
    mediaRecorder.start();
  }

  function stopRecording() {
    mediaRecorder?.stop();
  }

  function downloadRecording() {
    const blob = document.getElementById('downloadBtn').dataset.blob;
    if (!blob) return;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `recording-${new Date().toISOString().split('T')[0]}.webm`;
    a.click();
  }

  // Neon animation
  const canvas = document.getElementById('neonCanvas');
  const ctx = canvas.getContext('2d');
  let hue = 0, speed = 1, animOn = true;

  function drawNeon() {
    if (!animOn) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
    ctx.lineWidth = 4;
    ctx.moveTo(20, 20);
    ctx.lineTo(380, 20);
    ctx.lineTo(380, 130);
    ctx.lineTo(20, 130);
    ctx.lineTo(20, 20);
    ctx.stroke();
    hue = (hue + speed) % 360;
    requestAnimationFrame(drawNeon);
  }

  drawNeon();

  function toggleAnimation() {
    animOn = !animOn;
    if (animOn) drawNeon();
  }

  function cycleSpeed() {
    speed = speed === 0 ? 1 : speed === 1 ? 3 : speed === 3 ? 0 : 1;
  }

  function changeColor(color) {
    hue = parseInt(color.replace('#', ''), 16) % 360;
  }
</script>

<!-- Google APIs -->
<script src="https://apis.google.com/js/api.js"></script>
<script>
  const CLIENT_ID = '898010171923-45uc2mbusq1r3p845tl0au0h95lc9r7s.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyBsr1jRZElMibwMiRMek8Z3d204-7uF254';
  const DISCOVERY_DOCS = [
    'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
    'https://classroom.googleapis.com/$discovery/rest?version=v1'
  ];
  const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/classroom.coursework.students.readonly https://www.googleapis.com/auth/classroom.courses.readonly';

  function handleClientLoad() {
    gapi.load('client:auth2', initClient);
  }

  function initClient() {
    gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: DISCOVERY_DOCS,
      scope: SCOPES
    }).then(() => {
      const isSignedIn = gapi.auth2.getAuthInstance().isSignedIn.get();
      updateSigninStatus(isSignedIn);
      gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
    });
  }

  function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
      console.log('Signed in');
    } else {
      gapi.auth2.getAuthInstance().signIn();
    }
  }

  function uploadToDrive(blob, filename) {
    const file = new Blob([blob], { type: blob.type });
    const metadata = {
      name: filename,
      mimeType: blob.type
    };

    const accessToken = gapi.auth.getToken().access_token;
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', file);

    fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
      method: 'POST',
      headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
      body: form
    }).then(res => res.json()).then(val => {
      alert('Uploaded to Google Drive: File ID ' + val.id);
    });
  }

  function submitToClassroom(blob, filename) {
    gapi.client.classroom.courses.list().then(response => {
      const courses = response.result.courses || [];
      const courseId = prompt('Enter Course ID to submit to:');
      if (!courseId) return;
      uploadToDrive(blob, filename); // Can extend to attach to coursework later
    });
  }
</script>
<script async defer onload="handleClientLoad()"></script>
</body>
</html>
